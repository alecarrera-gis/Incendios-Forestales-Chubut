(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define(factory) :
    (global.L = global.L || {}, global.L.Control = global.L.Control || {}, global.L.Control.SideBySide = factory());
}(this, (function () { 'use strict';
    var mapWasDragEnabled;
    var mapWasTapEnabled;
    var SideBySide = L.Control.extend({
        options: {thumbSize: 42, padding: 0},
        initialize: function (leftLayers, rightLayers, options) {
            this.setLeftLayers(leftLayers);
            this.setRightLayers(rightLayers);
            L.setOptions(this, options);
        },
        getPosition: function () {
            var rangeValue = this._range.value;
            var offset = (0.5 - rangeValue) * (2 * this.options.padding + this.options.thumbSize);
            return this._map.getSize().x * rangeValue + offset;
        },
        setPosition: function(x){
            this._range.value = x / this._map.getSize().x;
            this._updateClip();
            return this;
        },
        setLeftLayers: function (leftLayers) {
            this._leftLayers = L.Util.isArray(leftLayers) ? leftLayers : [leftLayers];
            this._updateClip();
            return this;
        },
        setRightLayers: function (rightLayers) {
            this._rightLayers = L.Util.isArray(rightLayers) ? rightLayers : [rightLayers];
            this._updateClip();
            return this;
        },
        onAdd: function (map) {
            var container = this._container = L.DomUtil.create('div', 'leaflet-sbs', map._controlContainer);
            this._divider = L.DomUtil.create('div', 'leaflet-sbs-divider', container);
            this._range = L.DomUtil.create('input', 'leaflet-sbs-range', container);
            this._range.type = 'range';
            this._range.min = 0;
            this._range.max = 1;
            this._range.step = 'any';
            this._range.value = 0.5;
            this._range.style.paddingLeft = this._range.style.paddingRight = this.options.padding + 'px';
            this._addEvents();
            this._updateClip();
            return container;
        },
        onRemove: function (map) {
            this._removeEvents();
            L.DomUtil.remove(this._container);
        },
        _addEvents: function () {
            var range = this._range;
            var map = this._map;
            if (!range || !map) return;
            L.DomEvent.on(range, 'input change', this._updateClip, this);
            map.on('move', this._updateClip, this);
            L.DomEvent.on(range, 'touchstart mousedown', this._disableMap, this);
            L.DomEvent.on(range, 'touchend mouseup', this._enableMap, this);
        },
        _disableMap: function () {
            mapWasDragEnabled = this._map.dragging.enabled();
            mapWasTapEnabled = this._map.tap && this._map.tap.enabled();
            this._map.dragging.disable();
            this._map.tap && this._map.tap.disable();
        },
        _enableMap: function () {
            if (mapWasDragEnabled) this._map.dragging.enable();
            if (mapWasTapEnabled) this._map.tap.enable();
        },
        _removeEvents: function () {
            var range = this._range;
            var map = this._map;
            if (range) L.DomEvent.off(range, 'input change', this._updateClip, this);
            if (map) map.off('move', this._updateClip, this);
        },
        _updateClip: function () {
            var map = this._map;
            if (!map) return;
            var pre = '';
            var nw = map.containerPointToLayerPoint([0, 0]);
            var se = map.containerPointToLayerPoint(map.getSize());
            var clipX = this.getPosition();
            var dividerX = this._range.value * map.getSize().x;
            this._divider.style.left = dividerX + 'px';
            var clipLeft = 'rect(' + [nw.y, clipX, se.y, nw.x].join('px,') + 'px)';
            var clipRight = 'rect(' + [nw.y, se.x, se.y, clipX].join('px,') + 'px)';
            this._leftLayers.forEach(function (layer) {
                if (layer.getContainer) {
                    var container = layer.getContainer();
                    if (container) container.style.clip = clipLeft;
                }
            });
            this._rightLayers.forEach(function (layer) {
                if (layer.getContainer) {
                    var container = layer.getContainer();
                    if (container) container.style.clip = clipRight;
                }
            });
        }
    });
    L.control.sideBySide = function (leftLayers, rightLayers, options) {
        return new SideBySide(leftLayers, rightLayers, options);
    };
    return SideBySide;
})));